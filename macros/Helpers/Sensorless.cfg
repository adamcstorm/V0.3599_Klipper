[force_move]
enable_force_move: true

[gcode_macro HOME_IF_NEEDED]
gcode:
    {% if not 'xyz' in printer.toolhead.homed_axes %}
        STATUS_HOMING
        G28
        STATUS_DISPLAY_STANDBY
    {% endif %}
    
[gcode_macro _HOME_X]
gcode: 
	
	{% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
	{% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
	{% set HOME_CURRENT = 0.8 %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
	
	SET_KINEMATIC_POSITION X=15
	G91
	G1 X-10 F1200
	
	M400
	G28 X
	
	G91
	G1 X-10 F1200
	
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}

[gcode_macro _HOME_Y]
gcode: 
	{% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
	{% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
	{% set HOME_CURRENT = 0.8 %}
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
	
	SET_KINEMATIC_POSITION Y=15
	G91
	G1 Y-10 F1200
	
	M400
	G28 Y
	
	G91
	G1 Y-10 F1200
	
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}

[homing_override]
axes: xyz
set_position_z: 0
gcode: 
	{% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}
	
	SAVE_GCODE_STATE NAME=STATE_HOME_OVERRIDE
	{% set fan_speed_before_homing = printer.fan.speed * 255 %}
	M106 S0
	
	G1 Z4 F1200
	
	{% if home_all or 'X' in params %}
    	_HOME_X
	{% endif %}
	
	{% if home_all or 'Y' in params %}
    	_HOME_Y
	{% endif %}
	
	{% if home_all or 'Z' in params %}
	   	G28 Z
    	G90
    	G1 Z60 F1500
	{% endif %}
	
	G90
	M106 S{fan_speed_before_homing}
	RESTORE_GCODE_STATE NAME=STATE_HOME_OVERRIDE