[gcode_macro END_PRINT]
gcode: 
	
	{% set printcfg = printer['gcode_macro _printcfg'] %}
	{% set verbose = printcfg.verbose %}
	{% set disable_motors_in_end_print = printcfg.disable_motors_in_end_print %}
	{% set filter_active = printcfg.filter_active %}

    M400                           ; wait for buffer to clear
    
	PRINT_STATUS_MSG_STOP
	STATUS_COOLING
    G92 E0                         ; zero the extruder
    G1 E-2.0 F3600                 ; retract filament
    G91                            ; relative positioning
	
	PARK

    G1 E-18 F1200
	
	TURN_OFF_HEATERS
	TURN_OFF_FANS
	M400
	
	
	
	{% if filter_active %}
        {% set FILTER_TIME = params.FILTER_TIME|default(printcfg.filter_time)|int %}
        START_FILTER SPEED=1
        UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED DURATION={FILTER_TIME*60}
	{% endif %}
	
	{% if disable_motors_in_end_print %}
        M84
	{% endif %}
	
	M117 Print complete
	STATUS_PART_READY
	UPDATE_DELAYED_GCODE ID=clear_display DURATION=600
	_SAVE_IF_SET

[gcode_macro TURN_OFF_FANS]
gcode: 
	M107
	SET_FAN_SPEED FAN=aux_cooling SPEED=0